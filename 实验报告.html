<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>实验报告</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="fpm8" id="实验报告">实验报告</h1><div class="md-section-divider"></div><h2 data-anchor-id="sl6d" id="实验目的">实验目的</h2><p data-anchor-id="v194">追踪操作系统的启动过程，归纳关键事件</p><div class="md-section-divider"></div><h2 data-anchor-id="3ec2" id="实验平台工具">实验平台&amp;工具</h2><ul data-anchor-id="esju">
<li>ubuntu16.04-LTS    </li>
<li>gdb7.11.1</li>
<li>qemu 1:2.5+dfsg-5ubuntu10.24</li>
<li>dracut</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="fqip" id="实验过程">实验过程</h2><ul data-anchor-id="djgx">
<li>从此处下载最新稳定版本linuxkernel(4.15.14)</li>
<li>解压</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rj8t" style=""><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">mkdir linuxkernel            </span></code></li><li class="L1"><code class="language-bash"><span class="pln">cd linuxkernel </span></code></li><li class="L2"><code class="language-bash"><span class="pln">tar </span><span class="pun">-</span><span class="pln">xf linux</span><span class="pun">-</span><span class="lit">4.15</span><span class="pun">.</span><span class="lit">14.tar</span><span class="pun">.</span><span class="pln">gz </span></code></li><li class="L3"><code class="language-bash"><span class="pln">cd linux</span><span class="pun">-</span><span class="lit">4.15</span><span class="pun">.</span><span class="lit">14</span></code></li></ol></pre><ul data-anchor-id="dub4">
<li>编译配置</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="njaa" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pln">make menuconfig </span><span class="com">//配置编译选项</span></code></li></ol></pre><p data-anchor-id="9z2j">注意，在弹出的配置界面中需要注意设置以下选项： <br>
        1. <code>Kernel hacking</code>-&gt;<code>Compile the kernel with debug info</code> 选中 <br>
    2. （可选）<code>Processor type and features</code>-&gt;<code>Build a relocatable kernel</code>-&gt;<code>Randomize the address of the kernel image</code> <br>
其中，  为方便，第二个最好选中。若不选，在使用QEMU时，需要加上-append nokaslr <br>
原因：开机时，默认给kernel image分配随机空间。好处是可以更加安全，灵活;坏处是，调试的时候设置的断点位置无法定位image，导致最终在断点处不停止</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="lety" style=""><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">make </span><span class="pun">-</span><span class="pln">j4 </span><span class="pun">//</span><span class="lit">4</span><span class="pun">核加速编译</span></code></li><li class="L1"><code class="language-bash"><span class="pln">     </span><span class="pun">-</span><span class="pln">bzImage </span><span class="pun">//编译内核</span></code></li><li class="L2"><code class="language-bash"><span class="pln">     </span><span class="pun">-</span><span class="pln">vmlinux</span><span class="pun">//符号表，供</span><span class="pln">QEMU</span><span class="pun">使用</span></code></li></ol></pre><p data-anchor-id="vln7">以上选项可以避免编译无用模块，加速编译过程 <br>
此过程大约需要15分钟</p><p data-anchor-id="5xga">编译完成后，bzImage文件出现在./arch/x86/boot/目录下，vmlinux出现在当前目录下，随时可供后续调用</p><ul data-anchor-id="dmcs">
<li>制作initramfs镜像</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="16tz" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pln">dracut kver linux</span><span class="pun">-</span><span class="lit">4.15</span><span class="pun">.</span><span class="lit">14</span><span class="com">//匹配内核版本</span></code></li><li class="L1"><code class="language-Bash"><span class="pln">su root</span></code></li><li class="L2"><code class="language-Bash"><span class="pln">mv </span><span class="pun">/</span><span class="pln">boot</span><span class="pun">/</span><span class="pln">linuxramfs</span><span class="pun">-</span><span class="pln">linux</span><span class="pun">-</span><span class="lit">4.15</span><span class="pun">.</span><span class="lit">14.img</span><span class="pln"> </span><span class="pun">./</span><span class="pln">arch</span><span class="pun">/</span><span class="pln">x86</span><span class="pun">/</span><span class="pln">boot </span><span class="com">//移动至bzImage同一目录</span></code></li><li class="L3"><code class="language-Bash"><span class="com">//备注：当前目录为linux-4.15.14</span></code></li></ol></pre><p data-anchor-id="n6gc">注意,boot目录需要root权限，因此此后均切换为root用户操作</p><ul data-anchor-id="iyte">
<li>安装gdb, qemu,均使用最新版本</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="uvm7" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install gdb qemu</span></code></li></ol></pre><ul data-anchor-id="j20g">
<li>开始调试</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="4xcb" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pln">qemu</span><span class="pun">-</span><span class="pln">system</span><span class="pun">-</span><span class="pln">x86_64 </span><span class="pun">-</span><span class="pln">kernel arch</span><span class="pun">/</span><span class="pln">x86</span><span class="pun">/</span><span class="pln">boot</span><span class="pun">/</span><span class="pln">bzImage  </span><span class="com">//内核映像</span></code></li><li class="L1"><code class="language-Bash"><span class="pln">                   </span><span class="pun">-</span><span class="pln">initrd arch</span><span class="pun">/</span><span class="pln">x86</span><span class="pun">/</span><span class="pln">boot</span><span class="pun">/</span><span class="pln">initramfs</span><span class="pun">-</span><span class="pln">linux</span><span class="pun">-</span><span class="lit">4.15</span><span class="pun">.</span><span class="lit">14.img</span></code></li><li class="L2"><code class="language-Bash"><span class="pln">                   </span><span class="pun">-</span><span class="pln">s </span><span class="pun">-</span><span class="pln">S </span><span class="com">//-s表示-gdb tcp::1234, -S表示在开始时暂停qemu</span></code></li><li class="L3"><code class="language-Bash"><span class="pln">                   </span><span class="pun">-</span><span class="pln">m </span><span class="lit">2048</span><span class="pln"> </span><span class="com">//分配内存，防止开机过程错误</span></code></li></ol></pre><p data-anchor-id="obaq">另打开一个终端：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ayd3" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pln">gdb</span></code></li><li class="L1"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> file vmlinux </span><span class="com">//加载符号表</span></code></li><li class="L2"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> target remote </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1234</span><span class="pln"> </span><span class="com">//连接1234端口，远程控制qemu</span></code></li><li class="L3"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> b start_kernel </span><span class="com">//start_kernel处设断点</span></code></li><li class="L4"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> c </span><span class="com">//run </span></code></li></ol></pre><p data-anchor-id="vwji">遇到如下错误： <br>
<code>Remote 'g' packet reply is too long: 00000000000000005046010000000000000000000000000000000000000000000d352828000000005046010000000000303f2082f <br>
fffffff283f2082ffffffff00405182ffffffff0800000000000000a03e2082ffffffffe300000100000000000000000000000000 <br>
0000000000000000000000000000000000000000000000a5bb4982ffffffff4600000010000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000007f03000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <br>
00000000000000801f0000</code></p><p data-anchor-id="e1pi">参考<a href="https://stackoverflow.com/questions/48620622/how-to-solve-qemu-gdb-debug-error-remote-g-packet-reply-is-too-long" target="_blank">此处</a>,以及<a href="http://www.mamicode.com/info-detail-2139962.html" target="_blank">博客</a>得知问题原因为：</p><p data-anchor-id="ek5a">Note that other tutorials also add a "-S" parameter so QEMU starts the kernel stopped, however this is ommitted deliberately. The "-S" parameter would allow gdb to set an initial breakpoint anywhere in the kernel before kernel execution begins. Unfortunately, a change made to the gdbserver in QEMU, to support debugging 32- and 16-bit guest code in an x86_64 session breaks the -S functionality. The symptoms are that gdb prints out "Remote ‘g‘ packet reply is too long:", and fails to interact successfully with QEMU. The suggested fix is to run the QEMU until it is in 64-bit code (i.e. after the boot loader has finished and the kernel started) before connecting from gdb (omitting the -S parameter)</p><p data-anchor-id="fke0">参考<a href="http://bbs.85kf.com/a21.html" target="_blank">博客</a>，得到解决方案：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qdff" style=""><ol class="linenums"><li class="L0"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> disconnect</span></code></li><li class="L1"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">set</span><span class="pln"> arch i386</span><span class="pun">:</span><span class="pln">x86</span><span class="pun">-</span><span class="lit">64</span><span class="pun">:</span><span class="pln">intel</span></code></li><li class="L2"><code class="language-Bash"><span class="pun">(</span><span class="pln">gdb</span><span class="pun">)</span><span class="pln"> target remote </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1234</span></code></li></ol></pre><p data-anchor-id="ss7q">然后即可正常运行</p><ul data-anchor-id="e1id">
<li>调试结果</li>
</ul></div>
</body>
</html>